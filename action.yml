name: Deploy to RRP

inputs:
  edgio-deploy-token:
    description: 'The deploy token for Edgio.'
    required: true

runs:
  using: "composite"
  steps:
  - name: Check for Edgio deploy token secret
    if: ${{ inputs.edgio-deploy-token }} == ''
    run: |
      echo "You must define the 'EDGIO_DEPLOY_TOKEN' secret in GitHub project settings"
      exit 1
  - name: Extract branch name
    shell: bash
    run: echo "BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//_/g')" >> $GITHUB_ENV
  - uses: actions/checkout@v2
  - uses: actions/setup-node@v1
    with:
      node-version: 14
  - name: Cache node modules
    uses: actions/cache@v2
    env:
      cache-name: cache-node-modules
    with:
      path: ~/.npm
      key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
      restore-keys: |
        ${{ runner.os }}-build-${{ env.cache-name }}-
        ${{ runner.os }}-build-
        ${{ runner.os }}-
  - name: Install packages
    run: npm ci
  - name: Deploy to Edgio
    run: |
      npm run deploy -- ${{'--branch=$BRANCH_NAME' || ''}} --token=${{ inputs.edgio-deploy-token }}  \
      ${{github.event_name == 'push' && '--environment=default' || ''}} \
      ${{github.event_name == 'pull_request' && '--environment=staging' || ''}} \
      ${{github.event_name == 'release' && '--environment=production' || ''}}
